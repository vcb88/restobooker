# Iron Business Hostess Bot

## Обзор проекта

Iron Business Hostess Bot - это Telegram-бот, разработанный как **контр-агент для тестирования** нашей системы бронирования. Он эмулирует хостесс вымышленного ресторана "Ромашка", созданного специально для целей тестирования. Бот взаимодействует с пользователями через Telegram, использует Large Language Model (LLM) для обработки запросов и управляет бронированиями в in-memory базе данных.

Основная задача бота - обеспечить реалистичное взаимодействие для тестирования агента бронирования, пока основной агент не будет готов к работе с реальными ресторанами.

## Архитектура

Проект состоит из следующих основных компонентов:

1.  **`config.py`**: Содержит конфигурационные параметры, такие как API ID и Hash для Telegram, ключи и URL для LLM, часовой пояс и параметры вместимости ресторана.
2.  **`database.py`**: Реализует in-memory базу данных для хранения информации о бронированиях. Предоставляет методы для проверки доступности слотов, бронирования и предложения альтернативных вариантов.
3.  **`llm_service.py`**: Отвечает за взаимодействие с LLM. Формирует промпты для извлечения даты, времени, имени клиента и номера телефона из сообщений пользователя. Парсит ответы LLM. В текущей реализации используется моковый LLM.
4.  **`telegram_bot.py`**: Основной модуль бота. Инициализирует Telegram-клиент, обрабатывает входящие сообщения, взаимодействует с `LLMService` для парсинга запросов и с `ReservationDB` для управления бронированиями. Отправляет ответы пользователям.
5.  **`main.py`**: Точка входа в приложение. Инициализирует и запускает `TelegramBot`.

```
[Telegram User] <---> [Telegram Bot] <---> [LLM Service]
      ^                     |
      |                     v
      +----------------> [Reservation DB]
```

## Интерфейсы

### Telegram
Бот управляет реальным Telegram аккаунтом и обрабатывает только входящие сообщения, никогда не инициируя диалог первым.

### LLM Service
*   **Вход**: Текстовое сообщение от пользователя.
*   **Выход**: JSON-объект, содержащий извлеченную информацию или намерение.

### Reservation DB
*   **`is_slot_available(datetime_obj)`**: Проверяет, свободен ли слот.
*   **`book_slot(datetime_obj, client_name, phone_number)`**: Бронирует слот.
*   **`get_alternative_slots(requested_datetime_obj)`**: Предлагает свободные слоты вокруг запрошенного времени.

## Ключевые особенности

*   **Реалистичное взаимодействие:** Эмулирует поведение хостесс вымышленного ресторана "Ромашка" для бронирования столиков.
*   **Обработка входящих запросов:** Бот не пишет первым, но активно обрабатывает все входящие сообщения.
*   **Интеллектуальное приветствие:** При случайном запросе бот здоровается, представляется хостесс ресторана "Ромашка" и предлагает помощь в бронировании столика или ответе на вопросы.
*   **Управление бронированиями:**
    *   **Проверка доступности:** Проверяет свободные слоты на запрошенное время.
    *   **Проактивные предложения:** Если запрошенный слот занят, бот проактивно предлагает соседние свободные временные слоты.
    *   **Подтверждение и прощание:** После успешного бронирования бот подтверждает детали, прощается и желает хорошего дня.
*   **Гибкий парсинг времени:** Бот умеет оперировать относительными терминами времени (например, "завтра", "в субботу", "рано утром", "в обед") и при необходимости запрашивает уточнения.
*   **Ответы на вопросы о ресторане:** Бот может отвечать на вопросы о:
    *   **Графике работы:** Ежедневно, с 8:00 до 24:00.
    *   **Столиках:** Есть в зале и на веранде.
    *   **Парковке:** Есть возле ресторана.
    *   **Дополнительных услугах:** По выходным во второй половине дня играет живая музыка.
    *   **Меню:** Большое количество блюд из кухонь разных народов мира, основной акцент на русской домашней кухне.
*   **Уклончивые ответы:** На запросы, не связанные с бронированием или информацией о ресторане, бот отвечает уклончиво, перенаправляя разговор к своим основным функциям.

## Установка

1.  **Клонируйте репозиторий (если применимо) или создайте файлы вручную.**
2.  **Установите необходимые зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## Конфигурация

Создайте файл `config.py` (или используйте предоставленный) в директории `src/iron_business_hostess/` и заполните его своими данными.

### Основные настройки
Пример `config.py`:

```python
import os

class Config:
    # Telegram API credentials
    # Получите их на https://my.telegram.org/apps
    API_ID = int(os.getenv("TG_API_ID", "1234567"))
    API_HASH = os.getenv("TG_API_HASH", "your_api_hash_here")
    SESSION_NAME = "iron_business_hostess"

    # Настройки LLM (Поддерживаются OpenRouter, Ollama, LMStudio, OpenAI)
    LLM_API_KEY = os.getenv("LLM_API_KEY", "sk-or-...") 
    LLM_BASE_URL = os.getenv("LLM_BASE_URL", "https://openrouter.ai/api/v1")
    LLM_MODEL = os.getenv("LLM_MODEL", "openai/gpt-3.5-turbo")

    # Часовой пояс для бронирований (GMT+3)
    TIMEZONE = "Europe/Moscow"

    # Вместимость ресторана
    TABLE_CAPACITY = 1 
    SLOT_DURATION_MINUTES = 30
```

### Примеры настройки LLM

**OpenRouter (Рекомендуется - Grok):**
```python
LLM_API_KEY = "sk-or-..." # Ваш ключ OpenRouter
LLM_BASE_URL = "https://openrouter.ai/api/v1"
LLM_MODEL = "x-ai/grok-4.1-fast:free" # Точное название модели из проекта ailegal
```

**Ollama (Локально):**
```python
LLM_API_KEY = "ollama" # Любое значение
LLM_BASE_URL = "http://localhost:11434/v1"
LLM_MODEL = "llama3" # Убедитесь, что модель загружена (ollama pull llama3)
```

**LM Studio (Локально):**
```python
LLM_API_KEY = "lm-studio"
LLM_BASE_URL = "http://localhost:1234/v1"
LLM_MODEL = "local-model" # Часто игнорируется, но лучше указать
```

**Важно:** Для `API_ID` и `API_HASH` рекомендуется использовать переменные окружения или другой безопасный способ хранения.

## Запуск

1.  Убедитесь, что все зависимости установлены и `config.py` настроен.
2.  Запустите бота:
    ```bash
    python run.py
    ```
    При первом запуске Telethon запросит номер телефона для авторизации.

## Примеры использования

### Приветствие
*   **Пользователь**: Привет
*   **Бот**: Здравствуйте! Я хостесс ресторана "Ромашка". Могу помочь вам забронировать столик или ответить на вопросы.

### Бронирование (успешное)
*   **Пользователь**: Хочу забронировать столик сегодня на 18:00, Иван, +791234567890
*   **Бот**: Отлично, Иван! Ваш столик забронирован на 21.10.2025 в 18:00 по московскому времени. Номер телефона для связи: +791234567890. Ждем вас! Хорошего дня!

### Бронирование (слот занят)
*   **Пользователь**: Забронируйте столик сегодня на 18:00, Мария, +790987654321
*   **Бот**: К сожалению, столик на 21.10.2025 в 18:00 уже занят. Могу предложить следующие свободные слоты:
    21.10.2025 в 17:30
    21.10.2025 в 18:30
    ...

### Недостающая информация
*   **Пользователь**: Забронируйте столик сегодня на 19:00
*   **Бот**: Извините, я не смогла понять всю информацию. Пожалуйста, уточните: ваше имя, ваш номер телефона.

### Уклончивый ответ
*   **Пользователь**: Как дела?
*   **Бот**: Дела отлично, я готова помочь забронировать лучшие столики в ресторане "Ромашка"!

*   **Пользователь**: Какая погода?
*   **Бот**: Я не владею этой информацией, но с удовольствием помогу забронировать столик в ресторане "Ромашка".